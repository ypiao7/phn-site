<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PHN Prediction</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    :root{
      --color-primary:#00A389;
      --color-primary-dark:#008771;
      --color-light-accent:#E0F2F1;
      --color-body-bg:#f5f7fa;
    }
    body{background-color:var(--color-body-bg);}
    .page-title{
      text-align:center;margin-top:26px;margin-bottom:4px;
      font-weight:800;color:var(--color-primary);font-size:2.2rem;
      letter-spacing:0.3px;
    }
    .subtitle{ text-align:center;color:#6c757d;margin-bottom:22px;font-size:0.95rem;}
    .card{
      border-radius:10px;padding:18px 18px 8px 18px;margin-bottom:18px;
      border:none;background:#fff;box-shadow:0 4px 14px rgba(0,0,0,0.06);
    }
    .card h4{
      font-size:1rem;font-weight:700;color:#2b2f33;
      border-bottom:1px solid #e9ecef;padding-bottom:10px;margin-bottom:14px;
    }
    label{font-weight:600;font-size:0.78rem;color:#212529;margin-bottom:4px;}
    .form-control,.form-select{height:32px;font-size:0.82rem;padding:4px 10px;}
    .form-control:focus,.form-select:focus{
      border-color:var(--color-primary);
      box-shadow:0 0 0 0.2rem rgba(0,163,137,.18);
    }
    .normal-range-tip{
      display:block;font-size:0.67rem;color:#6c757d;margin-top:3px;line-height:1.15;
    }
    .btn-row{
      display:flex;gap:16px;justify-content:center;margin:12px 0 26px 0;
    }
    .btn-wide{
      flex:1;max-width:520px;height:34px;border-radius:6px;font-weight:700;
      border:none;
    }
    .btn-reset{background:#0aa389;color:#fff;}
    .btn-reset:hover{background:#08937b;}
    .btn-predict{background:#0aa389;color:#fff;}
    .btn-predict:hover{background:#08937b;}
    .small-note{ text-align:center;color:#6c757d;font-size:0.8rem;margin-bottom:26px;}
  </style>
</head>

<body>
  <div class="container" style="max-width: 1050px;">
    <div class="page-title">PHN Prediction</div>
    <div class="subtitle">Enter patient basic information to predict PHN</div>

    <!--  按钮必须在 form 内 -->
    <form id="phnForm">

      <!-- ================= Basic Information ================= -->
      <div class="card">
        <h4>Basic Information (*Required field)</h4>
        <div class="row g-3">

          <!-- Required -->
          <div class="col-md-3">
            <label for="age">*Age</label>
            <input type="number" class="form-control" id="age" name="age" min="0" max="200" required />
          </div>

          <div class="col-md-3">
            <label for="baseline_vas">*Baseline_VAS</label>
            <input type="number" step="0.1" class="form-control" id="baseline_vas" name="baseline_vas" min="0" max="10" required />
          </div>

          <div class="col-md-3">
            <label for="pcs_score">*PCS</label>
            <input type="number" step="0.01" class="form-control" id="pcs_score" name="pcs_score" min="0" required />
          </div>

          <div class="col-md-3">
            <label for="mcs_score">*MCS</label>
            <input type="number" step="0.01" class="form-control" id="mcs_score" name="mcs_ics_score" min="0" required />
          </div>

          <div class="col-md-3">
            <label for="psqi_score">*PSQI</label>
            <input type="number" step="1" class="form-control" id="psqi_score" name="psqi_score" min="0" max="21" required />
          </div>

          
          <div class="col-md-3">
            <label for="gender">Gender</label>
            <select class="form-select" id="gender" name="gender">
              <option value="" selected></option>
              <option value="1">Male</option>
              <option value="2">Female</option>
            </select>
          </div>

          <div class="col-md-3">
            <label for="bmi">BMI (kg/m²)</label>
            <input type="number" step="0.01" class="form-control" id="bmi" name="bmi" min="0" />
          </div>

          <div class="col-md-3">
            <label for="dm">DM</label>
            <select class="form-select" id="dm" name="dm">
              <option value="" selected></option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>

          <div class="col-md-3">
            <label for="hypertension">Hypertension</label>
            <select class="form-select" id="hypertension" name="hypertension">
              <option value="" selected></option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>

          <div class="col-md-3">
            <label for="chd">CHD</label>
            <select class="form-select" id="chd" name="chd">
              <option value="" selected></option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>

          <div class="col-md-3">
            <label for="nsaids_aceta">NSAIDs/Acetaminophen</label>
            <select class="form-select" id="nsaids_aceta" name="nsaids_acetaminophen_use">
              <option value="" selected></option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>

          <div class="col-md-3">
            <label for="oxy_aceta">Oxycodone/Acetaminophen</label>
            <select class="form-select" id="oxy_aceta" name="oxycodone_acetaminophen_use">
              <option value="" selected></option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>

        </div>
      </div>

      <!-- ================= Blood Information ================= -->
      <div class="card">
        <h4>Blood Information (*Required field)</h4>
        <div class="row g-3">

          <!-- Required (后端用这5个) -->
          <div class="col-md-3">
            <label for="ly_count">*LY# (×10⁹/L)</label>
            <input type="number" step="0.01" class="form-control" id="ly_count" name="ly_count" min="0" required />
            <span class="normal-range-tip">References: 1.1–3.2</span>
          </div>

          <div class="col-md-3">
            <label for="mono_count">*MO# (×10⁹/L)</label>
            <input type="number" step="0.01" class="form-control" id="mono_count" name="mono_count" min="0" required />
            <span class="normal-range-tip">References: 0.1–0.6</span>
          </div>

          <div class="col-md-3">
            <label for="alb">*ALB (g/L)</label>
            <input type="number" step="0.1" class="form-control" id="alb" name="alb" min="0" required />
            <span class="normal-range-tip">References: 40–55</span>
          </div>

          <div class="col-md-3">
            <label for="glu">*Glu (mmol/L)</label>
            <input type="number" step="0.01" class="form-control" id="glu" name="glu" min="0" required />
            <span class="normal-range-tip">References: 3.9–6.1</span>
          </div>

          <div class="col-md-3">
            <label for="a_g">*A/G</label>
            <input type="number" step="0.1" class="form-control" id="a_g" name="a_g" min="0" required />
            <span class="normal-range-tip">References: 1.2–2.4</span>
          </div>

          <!-- Optional fields（保留显示） --
            
          <div class="col-md-3">
            <label for="rbc">RBC (×10¹²/L)</label>
            <input type="number" step="0.01" class="form-control" id="rbc" name="rbc" min="0" />
            <span class="normal-range-tip">References:</span>
            <span class="normal-range-tip">Male: 4.5–5.9</span>
            <span class="normal-range-tip">Female: 4.1–5.1</span>
          </div>
      
          <div class="col-md-3">
            <label for="aptt_time">APTT(time) (s)</label>
            <input type="number" step="0.1" class="form-control" id="aptt_time" name="aptt_time" min="0" />
            <span class="normal-range-tip">References: 25–40</span>
          </div>

          <div class="col-md-3">
            <label for="neut_count">NEUT# (×10⁹/L)</label>
            <input type="number" step="0.01" class="form-control" id="neut_count" name="neut_count" min="0" />
            <span class="normal-range-tip">References: 1.8–6.3</span>
          </div>

          <div class="col-md-3">
            <label for="eo_count">EO# (×10⁹/L)</label>
            <input type="number" step="0.01" class="form-control" id="eo_count" name="eo_count" min="0" />
            <span class="normal-range-tip">References: 0.02–0.52</span>
          </div>

          <div class="col-md-3">
            <label for="ba_count">BA# (×10⁹/L)</label>
            <input type="number" step="0.01" class="form-control" id="ba_count" name="ba_count" min="0" />
            <span class="normal-range-tip">References: 0–0.06</span>
          </div>

          <div class="col-md-3">
            <label for="ly_percent">LY%</label>
            <input type="number" step="0.1" class="form-control" id="ly_percent" name="ly_percent" min="0" />
            <span class="normal-range-tip">References: 20–50</span>
          </div>

          <div class="col-md-3">
            <label for="mo_percent">MO%</label>
            <input type="number" step="0.1" class="form-control" id="mo_percent" name="mo_percent" min="0" />
            <span class="normal-range-tip">References: 3–10</span>
          </div>

          <div class="col-md-3">
            <label for="ba_percent">BA%</label>
            <input type="number" step="0.1" class="form-control" id="ba_percent" name="ba_percent" min="0" />
            <span class="normal-range-tip">References: 0–1</span>
          </div>

          <div class="col-md-3">
            <label for="mcv">MCV (fL)</label>
            <input type="number" step="0.1" class="form-control" id="mcv" name="mcv" min="0" />
            <span class="normal-range-tip">References: 80–100</span>
          </div>

          <div class="col-md-3">
            <label for="mchc">MCHC (g/L)</label>
            <input type="number" step="1" class="form-control" id="mchc" name="mchc" min="0" />
            <span class="normal-range-tip">References: 330–370</span>
          </div>

          <div class="col-md-3">
            <label for="rdw_cv">RDW-CV (%)</label>
            <input type="number" step="0.1" class="form-control" id="rdw_cv" name="rdw_cv" min="0" />
            <span class="normal-range-tip">References: 10.1–16.0</span>
          </div>

          <div class="col-md-3">
            <label for="plt">PLT (×10⁹/L)</label>
            <input type="number" step="1" class="form-control" id="plt" name="plt" min="0" />
            <span class="normal-range-tip">References: 150–350</span>
          </div>

          <div class="col-md-3">
            <label for="mpv">MPV (fL)</label>
            <input type="number" step="0.1" class="form-control" id="mpv" name="mpv" min="0" />
            <span class="normal-range-tip">References: 7.0–11.0</span>
          </div>

          <div class="col-md-3">
            <label for="tt_time">TT(time) (s)</label>
            <input type="number" step="0.1" class="form-control" id="tt_time" name="tt_time" min="0" />
            <span class="normal-range-tip">References: 11–14</span>
          </div>

          <div class="col-md-3">
            <label for="alt">ALT (U/L)</label>
            <input type="number" step="0.1" class="form-control" id="alt" name="alt" min="0" />
            <span class="normal-range-tip">References: 10–40</span>
          </div>

          <div class="col-md-3">
            <label for="ast">AST (U/L)</label>
            <input type="number" step="0.1" class="form-control" id="ast" name="ast" min="0" />
            <span class="normal-range-tip">References: 10–30</span>
          </div>

          <div class="col-md-3">
            <label for="tp">TP (g/L)</label>
            <input type="number" step="0.1" class="form-control" id="tp" name="tp" min="0" />
            <span class="normal-range-tip">References: 65–85</span>
          </div>

          <div class="col-md-3">
            <label for="urea">Urea (mmol/L)</label>
            <input type="number" step="0.1" class="form-control" id="urea" name="urea" min="0" />
            <span class="normal-range-tip">Ranges vary by age/sex</span>
          </div>

          <div class="col-md-3">
            <label for="cr">Cr (μmol/L)</label>
            <input type="number" step="0.1" class="form-control" id="cr" name="cr" min="0" />
            <span class="normal-range-tip">Ranges vary by age/sex</span>
          </div>

          <div class="col-md-3">
            <label for="co2">CO₂ (mmol/L)</label>
            <input type="number" step="0.1" class="form-control" id="co2" name="co2" min="0" />
            <span class="normal-range-tip">References: 22–28</span>
          </div>

          <div class="col-md-3">
            <label for="na">Na (mmol/L)</label>
            <input type="number" step="0.1" class="form-control" id="na" name="na" min="0" />
            <span class="normal-range-tip">References: 137–147</span>
          </div>

          <div class="col-md-3">
            <label for="k">K (mmol/L)</label>
            <input type="number" step="0.01" class="form-control" id="k" name="k" min="0" />
            <span class="normal-range-tip">References: 3.5–5.3</span>
          </div>

          <div class="col-md-3">
            <label for="glb">GLB (g/L)</label>
            <input type="number" step="0.1" class="form-control" id="glb" name="glb" min="0" />
            <span class="normal-range-tip">References: 20–40</span>
          </div>

          <div class="col-md-3">
            <label for="dbil">DBIL (μmol/L)</label>
            <input type="number" step="0.01" class="form-control" id="dbil" name="dbil" min="0" />
            <span class="normal-range-tip">References:<br\>Roche: ≤8.0<br/>DXC/AU: ≤4.0</span>
          </div>

          <div class="col-md-3">
            <label for="ibil">IBIL (μmol/L)</label>
            <input type="number" step="0.1" class="form-control" id="ibil" name="ibil" min="0" />
            <span class="normal-range-tip">IBIL = TBIL - DBIL</span>
          </div>

          <div class="col-md-3">
            <label for="egfr">eGFR (mL/min/1.73m²)</label>
            <input type="number" step="0.01" class="form-control" id="egfr" name="egfr" min="0" />
            <span class="normal-range-tip">References: 90-120</span>
          </div>

        </div>
      </div>

      <!-- ================= Buttons ================= -->
      <div class="btn-row">
        <button type="reset" class="btn-wide btn-reset">Reset</button>
        <button id="predictBtn" type="submit" class="btn-wide btn-predict">Predict</button>
      </div>

      <div class="small-note">
        This tool is for research/education only and does not constitute medical advice.
      </div>

    </form>
  </div>

  <script>
    const API_BASE = "https://phn-predict-q26i.onrender.com";
    const form = document.getElementById("phnForm");
    const btn = document.getElementById("predictBtn");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      btn.disabled = true;
      btn.textContent = "Predicting...";

      try {
        const fd = new FormData(form);

        // ✅ 后端真正用到的 10 个字段（用于预测）
        const payload = new FormData();
        [
          "age","pcs_score","mcs_ics_score","psqi_score",
          "ly_count","mono_count","alb","glu","a_g","baseline_vas"
        ].forEach(k => payload.append(k, fd.get(k) ?? ""));

        const r = await fetch(`${API_BASE}/api/predict`, { method: "POST", body: payload });
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || "Prediction failed");

        // ✅ 把“所有输入字段”也带到 results.html（用于保留显示/需要时）
        const all = {};
        for (const [k, v] of fd.entries()) all[k] = v ?? "";

        const qs = new URLSearchParams({
          risk_text: j.risk_text ?? (j.prediction_class === 1 ? "High Risk" : "Low Risk"),
          prediction_proba: String(j.prediction_proba ?? ""),
          inputs: encodeURIComponent(JSON.stringify(all))
        }).toString();

        window.location.href = `results.html?${qs}`;

      } catch (err) {
        alert("Prediction failed: " + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "Predict";
      }
    });
  </script>
</body>
</html>
